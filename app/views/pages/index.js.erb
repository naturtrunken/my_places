// Variables for the map
var map;
var marker = [];
var marker_data = [];
var marker_icon = [];
var visible_categories = [];
var marker_count = 0;
var category_marker = [];


$(document).ready(function () {

    // Bind the handling functions to the navigation links.
    $(".category_selection_link").click(function () {
        toggle_category($(this));
        redraw_marker();
        return false;
    });

    // Load the markers of the categories.
    create_category_marker();

    // Create the markers.
    create_marker_objects();
});

$(document).on('pagecreate', '#index', function (e) {

    // Load the map
    initmap();

    // Create all marker.
    create_marker();

    // Reload the map tiles after the (jquery mobile) initialisation again.
    setTimeout(function () {
        map.invalidateSize();
    }, 1);

    setTimeout(function () {

        // Add a button
        $('.leaflet-control-zoom').append(
                '<a href="#navigation" class="navigation-symbol">&#8801;</a>'
        );
    }, 3);

});


// Creates the map.
// ---------------------------------------------------------------------------------------
function initmap() {

    // Create the map
    map = new L.Map('map');

    // Create the OpenStreetMap and Leaflet note.
    var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib = 'Map data Â© OpenStreetMap contributors';
    var osm = new L.TileLayer(osmUrl, {
        minZoom: 4,
        maxZoom: 19,
        attribution: osmAttrib
    });
    map.addLayer(osm);

    map.setView(new L.LatLng(52.518611, 13.408056), 11);
}


// Create objects for all markers.
// ---------------------------------------------------------------------------------------
function create_marker() {
    <% @places.each do |place| %>
    marker_data[marker_count] = [<%= place.latitude %>, <%= place.longitude %>, <%= place.category_id %>];
    marker_count++;
    <% end %>
}


// Toggles a category id to the list of visible categories.
// ---------------------------------------------------------------------------------------
function toggle_category(e) {

    // Get the category_id from the data tag of the given element.
    var category_id = parseInt(e.attr('data-category_id'));

    if ($.inArray(category_id, visible_categories) == -1) {

        // The category was not selected before.

        // Add the category to the list.
        visible_categories.push(category_id);

    } else {

        // The category was selected before.

        // Remove the element.
        visible_categories.splice(visible_categories.indexOf(category_id), 1);
    }

    // Update the navigation view.
    toggle_navigation_selection(category_id);
}


// Create the marker of all selected categories on the map.
// ---------------------------------------------------------------------------------------
function redraw_marker() {

    // 1. Delete all marker.
    for (var i = 0; i < marker.length; i++) {
        map.removeLayer(marker[i]);
    }
    marker = [];
    marker_count = 0;

    // 2. Draw the selected markers.
    for (var i = 0; i < marker_data.length; i++) {

        // Contains the array visible_categories the value of the current
        // category_id in marker[i][2]?
        var index = $.inArray(marker_data[i][2], visible_categories);

        if (index == -1) {
            // No. Do nothing.
            continue;
        }

        // Yes. Draw the marker on the map.
        marker[marker_count] = L.marker(
                [marker_data[i][0], marker_data[i][1]],
                {
                    draggable: false,
                    icon: marker_icon[category_marker[marker_data[i][2]]]
                }
        );
        marker[marker_count].addTo(map);
        marker_count++;
    }

}


// Updates the state of the navigation elements.
// ---------------------------------------------------------------------------------------
function toggle_navigation_selection(category_id) {
    if ($('#category-' + category_id).hasClass('element_selected')) {
        $('#category-' + category_id).removeClass('element_selected');
    } else {
        $('#category-' + category_id).addClass('element_selected');
    }
}


// Creates the marker objects.
// ---------------------------------------------------------------------------------------
function create_marker_objects() {
    <% Marker.all.each do |marker| %>
    marker_icon[<%= marker.id.to_s %>] = L.icon({
        iconUrl: '/assets/images/<%= marker.icon %>.png',
        iconRetinaUrl: '/assets/images/<%= marker.icon %>-2x.png',
        iconSize: [25, 41],
        iconAnchor: [12, 40],
        popupAnchor: [-3, -76],
        shadowUrl: '',
        shadowRetinaUrl: '',
        shadowSize: [68, 95],
        shadowAnchor: [22, 94]
    });
    <% end %>
}


// ---------------------------------------------------------------------------------------
function create_category_marker() {
    <% Category.all.each do |category| %>
    category_marker[<%= category.id.to_s %>] = <%= category.marker_id %>;
    <% end %>
}

